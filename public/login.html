<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OnboardX — Login</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/login-style.css" />
</head>
<body>
  <div class="auth-container">
    <div class="auth-visual">
      <div class="hero">
        <div class="shape s1"></div>
        <div class="shape s2"></div>
        <div class="illustration">OnboardX — Contracts & Signatures</div>
      </div>
    </div>
    <div class="auth-card">
      <h2>Welcome to OnboardX</h2>
      <p class="muted">Sign in to review and sign contracts</p>

      <div class="role-row">
        <label><input type="radio" name="role" value="distributor" checked /> Distributor</label>
        <label><input type="radio" name="role" value="vendor" /> Vendor</label>
      </div>

      <div id="firebaseUi">
        <button id="googleSign" class="btn" style="width:100%">Sign in with Google</button>
      </div>

      <div class="sep">Or</div>
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <div class="auth-actions">
        <button id="signup" class="btn secondary">Sign up</button>
        <button id="signin" class="btn">Sign in</button>
      </div>

    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config provided by user
    const firebaseConfig = {
      apiKey: "AIzaSyChHZzycxzAT_z_iQ4NKDFj95tqekeD-A4",
      authDomain: "onboardx-1234.firebaseapp.com",
      projectId: "onboardx-1234",
      storageBucket: "onboardx-1234.firebasestorage.app",
      messagingSenderId: "85849489997",
      appId: "1:85849489997:web:b4c10d1d5cd942c2539204"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  const db = firebase.firestore();

    function selectedRole(){
      const r = document.querySelector('input[name=role]:checked');
      return r ? r.value : 'distributor';
    }

    // Helper: determine authoritative role from Firestore users doc (by uid). Falls back to selectedRole.
    async function resolveRoleAndStore(uid, email, chosenRole) {
      try {
        const ref = db.collection('users').doc(uid);
        const snap = await ref.get();
        if (snap && snap.exists) {
          const data = snap.data() || {};
          const roleFromDoc = data.role || chosenRole;
          // keep user record updated
          try { await ref.set({ email, role: roleFromDoc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); } catch (e) { /* ignore */ }
          localStorage.setItem('onboardx_user', JSON.stringify({ uid, role: roleFromDoc, email }));
          return roleFromDoc;
        }
        // no doc present: persist chosen role
        try { await ref.set({ email, role: chosenRole, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch (e) { /* ignore */ }
        localStorage.setItem('onboardx_user', JSON.stringify({ uid, role: chosenRole, email }));
        return chosenRole;
      } catch (e) {
        console.warn('resolveRole failed', e && e.message);
        localStorage.setItem('onboardx_user', JSON.stringify({ uid, role: chosenRole, email }));
        return chosenRole;
      }
    }

    document.getElementById('googleSign').addEventListener('click', async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const res = await auth.signInWithPopup(provider);
        const idToken = await res.user.getIdToken();
        const chosen = selectedRole();
        const email = res.user.email || '';
        const role = await resolveRoleAndStore(res.user.uid, email, chosen);
        // optional: inform server about identity
        try { await fetch('/api/user/identify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ idToken, role }) }); } catch(e){}
        if (role === 'vendor') window.location.href = '/vendor.html'; else window.location.href = '/';
      } catch (e) { alert('Auth failed: '+e.message); }
    });

    document.getElementById('signup').addEventListener('click', async ()=>{
      const emailInput = document.getElementById('email').value.trim();
      const pw = document.getElementById('password').value;
      if (!emailInput || !pw) return alert('email & password required');
      try {
        const res = await auth.createUserWithEmailAndPassword(emailInput, pw);
  const idToken = await res.user.getIdToken();
  const chosen = selectedRole();
  const userEmail = (res.user && res.user.email) ? res.user.email : emailInput;
  const role = await resolveRoleAndStore(res.user.uid, userEmail, chosen);
  try { await fetch('/api/user/identify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ idToken, role }) }); } catch(e){}
  if (role === 'vendor') window.location.href = '/vendor.html'; else window.location.href = '/';
      } catch (e) { alert('Signup failed: '+e.message); }
    });

    document.getElementById('signin').addEventListener('click', async ()=>{
      const emailInput = document.getElementById('email').value.trim();
      const pw = document.getElementById('password').value;
      if (!emailInput || !pw) return alert('email & password required');
      try {
        const res = await auth.signInWithEmailAndPassword(emailInput, pw);
  const idToken = await res.user.getIdToken();
  const chosen = selectedRole();
  const userEmail = (res.user && res.user.email) ? res.user.email : emailInput;
  const role = await resolveRoleAndStore(res.user.uid, userEmail, chosen);
  try { await fetch('/api/user/identify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ idToken, role }) }); } catch(e){}
  if (role === 'vendor') window.location.href = '/vendor.html'; else window.location.href = '/';
      } catch (e) { alert('Signin failed: '+e.message); }
    });
  </script>
</body>
</html>
