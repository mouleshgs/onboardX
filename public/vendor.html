<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vendor Dashboard — OnboardX</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/chat-widget.css" />
</head>
<body>
  <div class="app-shell">
    <div class="topbar">
      <div class="brand"><div class="brand__logo">OX</div><div class="brand__title">Vendor Dashboard</div></div>
      <div><button onclick="logout()" class="btn secondary">Logout</button></div>
    </div>

    <div class="panel" style="max-width:820px; margin:0 auto">
      <h3>Upload a contract PDF and send it to a distributor</h3>
      <div class="card">
        <div style="flex:1">
          <div class="form-row">
            <label class="small muted">Distributor email</label>
            <input id="distEmail" placeholder="distributor@example.com" type="email" />
            <label class="small muted">Your email</label>
            <input id="vendorEmail" placeholder="you@vendor.com" />
            <label class="small muted">Select PDF</label>
            <input id="fileInput" type="file" accept="application/pdf" />
          </div>
        </div>
        <div style="align-self:center">
          <button id="sendBtn" class="btn">Upload & Send</button>
        </div>
      </div>

      <div id="result" style="margin-top:12px"></div>
      
      <div style="margin-top:22px">
        <h4>Your contracts</h4>
        <div id="vendorContracts" class="list"></div>
      </div>
    </div>
  </div>
  <script>
    function logout(){ localStorage.removeItem('onboardx_user'); window.location.href = '/login.html'; }
      // simple toast for legacy static page
      function showToast(msg, type) {
        try {
          const id = '__onboardx_toast_static';
          let container = document.getElementById(id);
          if (!container) { 
            container = document.createElement('div'); 
            container.id = id; 
            container.style.position = 'fixed'; 
            container.style.right = '20px'; 
            container.style.top = '20px'; 
            container.style.zIndex = '999999'; 
            container.style.display = 'flex'; 
            container.style.flexDirection = 'column'; 
            container.style.gap = '8px'; 
            document.body.appendChild(container); 
          }
          const el = document.createElement('div'); 
          el.textContent = msg; 
          el.style.padding = '10px 12px'; 
          el.style.borderRadius = '8px'; 
          el.style.maxWidth = '360px'; 
          el.style.boxShadow = '0 6px 20px rgba(0,0,0,0.12)'; 
          el.style.fontSize = '14px'; 
          el.style.background = (type === 'success') ? '#dcfce7' : (type === 'error') ? '#fee2e2' : (type === 'warn') ? '#fff7ed' : '#f3f4f6'; 
          container.appendChild(el); 
          setTimeout(()=>{ try { el.remove(); } catch(e){} }, 4200);
        } catch (e) { try { alert(msg); } catch (e) {} }
      }
    (function(){ try{ const raw = localStorage.getItem('onboardx_user'); if (!raw) return window.location.replace('/login.html'); const u = JSON.parse(raw); if (u.role !== 'vendor') window.location.replace('/'); if (u.email) document.getElementById('vendorEmail').value = u.email; } catch(e){ window.location.replace('/login.html'); }})();

    document.getElementById('sendBtn').addEventListener('click', async ()=>{
      const dist = document.getElementById('distEmail').value.trim();
      const vendor = document.getElementById('vendorEmail').value.trim() || 'vendor@local';
      const f = document.getElementById('fileInput').files[0];
    if (!dist) { showToast('distributor email required','warn'); return; }
    if (!f) { showToast('select a PDF file','warn'); return; }
      const fd = new FormData();
      fd.append('file', f);
      fd.append('distributorEmail', dist);
      fd.append('vendorEmail', vendor);
      fd.append('vendorId', vendor.replace(/[^a-z0-9]/gi,'').toLowerCase());
      const res = await fetch('/api/vendor/upload', { method: 'POST', body: fd });
      const j = await res.json();
      if (res.ok) {
        document.getElementById('result').innerHTML = `<div>Uploaded. Contract id: ${j.id} ${j.storageUrl ? `<div><a href="${j.storageUrl}" target="_blank">Open in Dropbox</a></div>` : ''}</div>`;
          showToast('Uploaded successfully', 'success');
      } else {
        document.getElementById('result').textContent = 'Error: ' + (j.error || j.detail || 'unknown');
          showToast('Upload failed', 'error');
      }
    });

    // vendor contracts list
    const vendorContractsEl = document.getElementById('vendorContracts');
    async function loadVendorContracts(){
      const vendor = document.getElementById('vendorEmail').value.trim();
      if (!vendor) return;
      const q = new URLSearchParams({ vendorEmail: vendor });
      const r = await fetch('/api/vendor/contracts?'+q.toString());
      const list = await r.json();
      vendorContractsEl.innerHTML = '';
      if (!list.length) { vendorContractsEl.innerHTML = '<div class="muted">No contracts yet</div>'; return; }
      list.slice().reverse().forEach(c => {
        const card = document.createElement('div'); card.className = 'card';
        const meta = document.createElement('div'); meta.className = 'meta';
        const title = document.createElement('div'); title.className = 'title'; title.textContent = c.originalName || c.id;
        const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = `ID: ${c.id} • ${c.status || 'pending'}`;
        meta.appendChild(title); meta.appendChild(sub);
        const right = document.createElement('div'); right.style.marginLeft='auto';
        const distributor = document.createElement('div'); distributor.className='small muted'; distributor.textContent = `To: ${c.assignedToEmail || '—'}`;

        // onboarding status indicator (will be updated after fetching access)
        const statusWrap = document.createElement('div'); statusWrap.style.margin = '6px 8px 0 0';
        statusWrap.className = 'small muted';
        statusWrap.textContent = 'Checking onboarding...';

        const btn = document.createElement('button'); btn.className='btn'; btn.textContent = c.status === 'signed' ? 'View Signed' : 'View';
        btn.addEventListener('click', ()=>{
          // open Dropbox link or local via server
          if (c.storageUrl) window.open(c.storageUrl, '_blank'); else window.open(`/signed/${c.signedFile || c.file}`,'_blank');
        });

        // Nudge button — always visible on vendor cards
        const nudgeBtn = document.createElement('button');
        nudgeBtn.className = 'btn secondary';
        nudgeBtn.style.marginLeft = '8px';
        nudgeBtn.textContent = 'Nudge Distributor';
        nudgeBtn.addEventListener('click', async () => {
          try {
            nudgeBtn.disabled = true; nudgeBtn.textContent = 'Sending...';
            // don't require server to supply message; server will choose sensible default
            const payload = { from: document.getElementById('vendorEmail').value || 'vendor' };
            const r = await fetch('/api/contract/' + encodeURIComponent(c.id) + '/nudge', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
            const j = await r.json();
            if (r.ok && j && j.nudge) {
            showToast('Nudge sent to ' + (j.nudge.to || 'distributor') + ': "' + j.nudge.message + '"', 'success');
            } else {
            showToast('Failed to send nudge: ' + (j.error || j.detail || 'unknown'), 'error');
            }
          } catch (e) { alert('Network error'); }
          nudgeBtn.disabled = false; nudgeBtn.textContent = 'Nudge Distributor';
        });

        right.appendChild(distributor);
        right.appendChild(statusWrap);
        right.appendChild(btn);
        right.appendChild(nudgeBtn);
        card.appendChild(meta); card.appendChild(right);
        vendorContractsEl.appendChild(card);

        // Try to fetch the contract access to determine onboarding progress.
        // The server will return 403 if contract not signed yet; treat that as not started.
        (async () => {
          try {
            const resp = await fetch('/api/contract/' + encodeURIComponent(c.id) + '/access');
            if (!resp.ok) {
              // if forbidden or not found, show not started
              if (resp.status === 403 || resp.status === 404) {
                statusWrap.textContent = 'Onboarding: not started';
                statusWrap.className = 'small muted';
                return;
              }
              statusWrap.textContent = 'Onboarding: unknown';
              statusWrap.className = 'small muted';
              return;
            }
            const j = await resp.json();
            const access = j && j.access ? j.access : (j && j.ok && j.access) ? j.access : null;
            if (!access) {
              statusWrap.textContent = 'Onboarding: not started';
              statusWrap.className = 'small muted';
              return;
            }
            const prog = typeof access.progress === 'number' ? access.progress : (access && access.progress) ? Number(access.progress) : 0;
            if (prog >= 100) {
              statusWrap.textContent = 'Onboarding: completed ✅';
              statusWrap.className = 'small success';
            } else {
              statusWrap.textContent = `Onboarding: ${prog}%`;
              statusWrap.className = 'small muted';
            }
          } catch (e) {
            statusWrap.textContent = 'Onboarding: unknown';
            statusWrap.className = 'small muted';
          }
        })();
      });
    }

    // initial load
    loadVendorContracts();

    // Floating RAG chat button and modal (lightweight, calls /api/chat)
    (function(){
      const wrap = document.createElement('div');
      wrap.style.position = 'fixed';
      wrap.style.right = '20px';
      wrap.style.bottom = '20px';
      wrap.style.zIndex = '99999';

      const btn = document.createElement('button');
      btn.textContent = '💬';
      btn.title = 'Ask OnboardX';
      btn.style.width = '56px'; btn.style.height = '56px'; btn.style.borderRadius = '999px'; btn.style.border = 'none'; btn.style.background = '#ef4444'; btn.style.color = '#fff'; btn.style.fontSize = '20px'; btn.style.cursor = 'pointer'; btn.style.boxShadow = '0 6px 18px rgba(0,0,0,0.18)';
      wrap.appendChild(btn);

      const modal = document.createElement('div');
      modal.style.position = 'fixed'; modal.style.right = '20px'; modal.style.bottom = '88px'; modal.style.zIndex = '99999'; modal.style.width = '360px'; modal.style.maxWidth = '90%'; modal.style.display = 'none';
      modal.innerHTML = `<div style="background:#fff;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.18);overflow:hidden">
        <div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center"><strong>Assist</strong><button id="__chatClose" class="btn secondary">Close</button></div>
        <div id="__chatList" style="max-height:300px;overflow:auto;display:flex;flex-direction:column-reverse;padding:10px"></div>
        <div style="padding:10px;border-top:1px solid #eee;display:flex;gap:8px"><input id="__chatInput" placeholder="Ask about onboarding or contracts" style="flex:1;padding:8px 10px;border-radius:6px;border:1px solid #e5e7eb" /><button id="__chatSend" class="btn">Send</button></div>
      </div>`;
      document.body.appendChild(wrap);
      document.body.appendChild(modal);

      btn.addEventListener('click', async ()=>{
        modal.style.display = 'block';
        // fetch welcome (try relative path first, then explicit backend)
        try {
          let r = await fetch('/api/chat/welcome');
          let j = null;
          if (r.ok) {
            try { j = await r.json(); } catch (e) { j = null; }
          }
          if (!j) {
            console.warn('Relative /api/chat/welcome failed or not JSON, retrying with http://localhost:3000');
            try { r = await fetch('http://localhost:3000/api/chat/welcome'); if (r.ok) j = await r.json(); } catch (e) { console.error('welcome fallback failed', e); }
          }
          if (j && j.welcome) {
            const list = modal.querySelector('#__chatList');
            const item = document.createElement('div'); item.style.marginTop='8px'; item.style.textAlign='left'; const b = document.createElement('div'); b.style.display='inline-block'; b.style.background='#f3f4f6'; b.style.padding='8px 10px'; b.style.borderRadius='8px'; b.textContent = j.welcome; item.appendChild(b); list.insertBefore(item, list.firstChild);
          }
        } catch(e){ console.error('welcome fetch failed', e); }
      });

      modal.querySelector('#__chatClose').addEventListener('click', ()=>{ modal.style.display = 'none'; });
      modal.querySelector('#__chatSend').addEventListener('click', async ()=>{
        const input = modal.querySelector('#__chatInput');
        const text = input.value.trim(); if (!text) return; input.value = '';
        const list = modal.querySelector('#__chatList');
        const u = document.createElement('div'); u.style.marginTop='8px'; u.style.textAlign='right'; const ub = document.createElement('div'); ub.style.display='inline-block'; ub.style.background='#fee2e2'; ub.style.padding='8px 10px'; ub.style.borderRadius='8px'; ub.textContent = text; u.appendChild(ub); list.insertBefore(u, list.firstChild);
        try {
          let r = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ message: text }) });
          let j = null;
          if (r.ok) {
            try { j = await r.json(); } catch (e) { j = null; }
          }
          if (!j) {
            console.warn('Relative /api/chat POST failed or non-JSON; retrying with http://localhost:3000');
            try { r = await fetch('http://localhost:3000/api/chat', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ message: text }) }); if (r.ok) j = await r.json(); } catch (e) { console.error('chat fallback failed', e); }
          }
          const reply = (j && j.reply) ? j.reply : 'No reply';
          const b = document.createElement('div'); b.style.marginTop='8px'; b.style.textAlign='left'; const bb = document.createElement('div'); bb.style.display='inline-block'; bb.style.background='#f3f4f6'; bb.style.padding='8px 10px'; bb.style.borderRadius='8px'; bb.textContent = reply; b.appendChild(bb); list.insertBefore(b, list.firstChild);
        } catch (e) {
          console.error('chat send failed', e);
          const b = document.createElement('div'); b.style.marginTop='8px'; b.style.textAlign='left'; const bb = document.createElement('div'); bb.style.display='inline-block'; bb.style.background='#f3f4f6'; bb.style.padding='8px 10px'; bb.style.borderRadius='8px'; bb.textContent = 'Network error'; b.appendChild(bb); list.insertBefore(b, list.firstChild);
        }
      });
    })();
  </script>
  <script src="/chat-widget.js"></script>
</body>
</html>
