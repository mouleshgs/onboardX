<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vendor Dashboard — OnboardX</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/chat-widget.css" />
</head>
<body>
  <div class="app-shell">
    <div class="topbar">
      <div class="brand"><div class="brand__logo">OX</div><div class="brand__title">Vendor Dashboard</div></div>
      <div><button onclick="logout()" class="btn secondary">Logout</button></div>
    </div>

    <div class="panel" style="max-width:820px; margin:0 auto">
      <h3>Upload a contract PDF and send it to a distributor</h3>
      <div class="card">
        <div style="flex:1">
          <div class="form-row">
            <label class="small muted">Distributor email</label>
            <input id="distEmail" placeholder="distributor@example.com" type="email" />
            <label class="small muted">Your email</label>
            <input id="vendorEmail" placeholder="you@vendor.com" />
            <label class="small muted">Select PDF</label>
            <input id="fileInput" type="file" accept="application/pdf" />
          </div>
        </div>
        <div style="align-self:center">
          <button id="sendBtn" class="btn">Upload & Send</button>
        </div>
      </div>

      <div id="result" style="margin-top:12px"></div>
      
      <div style="margin-top:22px">
        <h4>Your contracts</h4>
        <div id="vendorContracts" class="list"></div>
      </div>
    </div>
  </div>
  <script>
    function logout(){ localStorage.removeItem('onboardx_user'); window.location.href = '/login.html'; }
    (function(){ try{ const raw = localStorage.getItem('onboardx_user'); if (!raw) return window.location.replace('/login.html'); const u = JSON.parse(raw); if (u.role !== 'vendor') window.location.replace('/'); if (u.email) document.getElementById('vendorEmail').value = u.email; } catch(e){ window.location.replace('/login.html'); }})();

    document.getElementById('sendBtn').addEventListener('click', async ()=>{
      const dist = document.getElementById('distEmail').value.trim();
      const vendor = document.getElementById('vendorEmail').value.trim() || 'vendor@local';
      const f = document.getElementById('fileInput').files[0];
      if (!dist) return alert('distributor email required');
      if (!f) return alert('select a PDF file');
      const fd = new FormData();
      fd.append('file', f);
      fd.append('distributorEmail', dist);
      fd.append('vendorEmail', vendor);
      fd.append('vendorId', vendor.replace(/[^a-z0-9]/gi,'').toLowerCase());
      const res = await fetch('/api/vendor/upload', { method: 'POST', body: fd });
      const j = await res.json();
      if (res.ok) {
        document.getElementById('result').innerHTML = `<div>Uploaded. Contract id: ${j.id} ${j.storageUrl ? `<div><a href="${j.storageUrl}" target="_blank">Open in Dropbox</a></div>` : ''}</div>`;
      } else {
        document.getElementById('result').textContent = 'Error: ' + (j.error || j.detail || 'unknown');
      }
    });

    // vendor contracts list
    const vendorContractsEl = document.getElementById('vendorContracts');
    async function loadVendorContracts(){
      const vendor = document.getElementById('vendorEmail').value.trim();
      if (!vendor) return;
      const q = new URLSearchParams({ vendorEmail: vendor });
      const r = await fetch('/api/vendor/contracts?'+q.toString());
      const list = await r.json();
      vendorContractsEl.innerHTML = '';
      if (!list.length) { vendorContractsEl.innerHTML = '<div class="muted">No contracts yet</div>'; return; }
      list.slice().reverse().forEach(c => {
        const card = document.createElement('div'); card.className = 'card';
        const meta = document.createElement('div'); meta.className = 'meta';
        const title = document.createElement('div'); title.className = 'title'; title.textContent = c.originalName || c.id;
        const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = `ID: ${c.id} • ${c.status || 'pending'}`;
        meta.appendChild(title); meta.appendChild(sub);
        const right = document.createElement('div'); right.style.marginLeft='auto';
        const distributor = document.createElement('div'); distributor.className='small muted'; distributor.textContent = `To: ${c.assignedToEmail || '—'}`;

        // onboarding status indicator (will be updated after fetching access)
        const statusWrap = document.createElement('div'); statusWrap.style.margin = '6px 8px 0 0';
        statusWrap.className = 'small muted';
        statusWrap.textContent = 'Checking onboarding...';

        const btn = document.createElement('button'); btn.className='btn'; btn.textContent = c.status === 'signed' ? 'View Signed' : 'View';
        btn.addEventListener('click', ()=>{
          // open Dropbox link or local via server
          if (c.storageUrl) window.open(c.storageUrl, '_blank'); else window.open(`/signed/${c.signedFile || c.file}`,'_blank');
        });

        // Nudge button — always visible on vendor cards
        const nudgeBtn = document.createElement('button');
        nudgeBtn.className = 'btn secondary';
        nudgeBtn.style.marginLeft = '8px';
        nudgeBtn.textContent = 'Nudge Distributor';
        nudgeBtn.addEventListener('click', async () => {
          try {
            nudgeBtn.disabled = true; nudgeBtn.textContent = 'Sending...';
            // don't require server to supply message; server will choose sensible default
            const payload = { from: document.getElementById('vendorEmail').value || 'vendor' };
            const r = await fetch('/api/contract/' + encodeURIComponent(c.id) + '/nudge', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
            const j = await r.json();
            if (r.ok && j && j.nudge) {
              alert('Nudge sent to ' + (j.nudge.to || 'distributor') + '\n\n"' + j.nudge.message + '"');
            } else {
              alert('Failed to send nudge: ' + (j.error || j.detail || 'unknown'));
            }
          } catch (e) { alert('Network error'); }
          nudgeBtn.disabled = false; nudgeBtn.textContent = 'Nudge Distributor';
        });

        right.appendChild(distributor);
        right.appendChild(statusWrap);
        right.appendChild(btn);
        right.appendChild(nudgeBtn);
        card.appendChild(meta); card.appendChild(right);
        vendorContractsEl.appendChild(card);

        // Try to fetch the contract access to determine onboarding progress.
        // The server will return 403 if contract not signed yet; treat that as not started.
        (async () => {
          try {
            const resp = await fetch('/api/contract/' + encodeURIComponent(c.id) + '/access');
            if (!resp.ok) {
              // if forbidden or not found, show not started
              if (resp.status === 403 || resp.status === 404) {
                statusWrap.textContent = 'Onboarding: not started';
                statusWrap.className = 'small muted';
                return;
              }
              statusWrap.textContent = 'Onboarding: unknown';
              statusWrap.className = 'small muted';
              return;
            }
            const j = await resp.json();
            const access = j && j.access ? j.access : (j && j.ok && j.access) ? j.access : null;
            if (!access) {
              statusWrap.textContent = 'Onboarding: not started';
              statusWrap.className = 'small muted';
              return;
            }
            const prog = typeof access.progress === 'number' ? access.progress : (access && access.progress) ? Number(access.progress) : 0;
            if (prog >= 100) {
              statusWrap.textContent = 'Onboarding: completed ✅';
              statusWrap.className = 'small success';
            } else {
              statusWrap.textContent = `Onboarding: ${prog}%`;
              statusWrap.className = 'small muted';
            }
          } catch (e) {
            statusWrap.textContent = 'Onboarding: unknown';
            statusWrap.className = 'small muted';
          }
        })();
      });
    }

    // poll every 5s to pick up signed docs
    setInterval(loadVendorContracts, 5000);
    // initial load
    loadVendorContracts();
  </script>
  <script src="/chat-widget.js"></script>
</body>
</html>
